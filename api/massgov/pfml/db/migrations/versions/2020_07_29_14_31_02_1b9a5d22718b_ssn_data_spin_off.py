"""ssn data spin off

Revision ID: 1b9a5d22718b
Revises: 41c8392db33c
Create Date: 2020-07-29 14:31:02.335598

"""
import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import postgresql

from massgov.pfml.db.models.employees import TaxIdentifier  # noqa: F401

# revision identifiers, used by Alembic.
revision = "1b9a5d22718b"
down_revision = "41c8392db33c"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "tax_identifier",
        sa.Column("tax_identifier_id", postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column("tax_identifier", sa.Text(), nullable=False),
        sa.PrimaryKeyConstraint("tax_identifier_id"),
        sa.UniqueConstraint("tax_identifier"),
    )
    op.add_column(
        "application", sa.Column("tax_identifier_id", postgresql.UUID(as_uuid=True), nullable=True)
    )
    op.create_foreign_key(
        None, "application", "tax_identifier", ["tax_identifier_id"], ["tax_identifier_id"]
    )
    op.add_column(
        "employee", sa.Column("tax_identifier_id", postgresql.UUID(as_uuid=True), nullable=True)
    )
    op.create_foreign_key(
        None, "employee", "tax_identifier", ["tax_identifier_id"], ["tax_identifier_id"]
    )

    # bind = op.get_bind()
    # session = sa.orm.Session(bind=bind)
    #
    # op.execute(
    #     "INSERT INTO tax_identifier(tax_identifier) SELECT DISTINCT tax_identifier FROM employee"
    # )
    #
    # for tax_id in session.query(TaxIdentifier):
    #     tax_id.tax_identifier_id = uuid_gen()
    #
    # session.commit()
    #
    # op.execute(
    #     "UPDATE employee SET tax_identifier_id = tax_identifier.tax_identifier_id FROM employee AS e JOIN tax_identifier ON e.tax_identifier = tax_identifier.tax_identifier"
    # )

    op.drop_column("employee", "tax_identifier")
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "employee", sa.Column("tax_identifier", sa.TEXT(), autoincrement=False, nullable=True)
    )
    op.drop_constraint("employee_tax_identifier_id_fkey", "employee", type_="foreignkey")
    op.drop_column("employee", "tax_identifier_id")
    op.drop_constraint("application_tax_identifier_id_fkey", "application", type_="foreignkey")
    op.drop_column("application", "tax_identifier_id")
    op.drop_table("tax_identifier")
    # ### end Alembic commands ###
