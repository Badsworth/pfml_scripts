"""Make DOR DBA nullable

Revision ID: 6318fab9e6ae
Revises: 62daadb5a349
Create Date: 2021-11-17 15:53:13.035099

"""
import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision = "ea3f562fe685"
down_revision = "6318fab9e6ae"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column("employer", "employer_dba", existing_type=sa.TEXT(), nullable=True)

    op.execute(
        """
        UPDATE employer
        SET employer_dba = NULL
        WHERE employer_dba = ''
        """
    )

    op.execute(
        """
        UPDATE employer
        SET employer_name = NULL
        WHERE employer_name = ''
        """
    )

    op.execute(
        """
        UPDATE address a
            SET address_line_one=NULLIF(address_line_one, ''),
                address_line_two=NULLIF(address_line_two, ''),
                city=NULLIF(city, ''),
                geo_state_text=NULLIF(geo_state_text, ''),
                zip_code=NULLIF(zip_code, '')
            FROM link_employer_address la
            WHERE la.address_id= a.address_id
            AND (address_line_one = ''
                OR address_line_two = ''
                OR city = ''
                OR geo_state_text = ''
                OR zip_code = ''
            )
        """
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column("employer", "employer_dba", existing_type=sa.TEXT(), nullable=False)
    # ### end Alembic commands ###
