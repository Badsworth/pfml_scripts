openapi: 3.0.2
info:
  title: Paid Leave API
  description: An API for managing leave within Massachusetts Paid Family and Medical Leave.
  version: "2020-05-08"

servers:
  - url: /v1
    description: Development server

security:
  - jwt: [] # JWT authentication option
  - {} # no authentication option

paths:
  /status:
    get:
      tags:
        - Test Endpoints
      summary: Get the API status
      responses:
        "200":
          description: A status object
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                example:
                  status: "ok"

  /users/{user_id}:
    get:
      tags:
        - Users
      summary: Retrieve a User account
      operationId: massgov.pfml.api.users.users_get
      parameters:
        - name: user_id
          in: path
          schema:
            type: string
            format: uuid
          description: ID of User to update
          required: true
      responses:
        "200":
          description: A successful request returns a 200 status code and a user object.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      tags:
        - Users
      summary: Update a User account
      operationId: massgov.pfml.api.users.users_patch
      parameters:
        - name: user_id
          in: path
          schema:
            type: string
          description: ID of User to update
          required: true
      responses:
        "200":
          description: A successful request returns a 200 status code and a user object.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "404":
          $ref: "#/components/responses/NotFound"
      requestBody:
        $ref: "#/components/requestBodies/UserUpdateRequest"

  /users/current:
    get:
      tags:
        - Users
      summary: >
        Retrieve the User account corresponding to the currently authenticated
        user
      operationId: massgov.pfml.api.users.users_current_get
      responses:
        "200":
          description: A successful request returns a 200 status code and a user object.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "404":
          $ref: "#/components/responses/NotFound"

  /employees/{employee_id}:
    get:
      tags:
        - Employees
      summary: Retrieve an Employee record
      operationId: massgov.pfml.api.employees.employees_get
      parameters:
        - name: employee_id
          in: path
          schema:
            type: string
          description: ID of Employee to retrieve
          required: true
      responses:
        "200":
          description: A successful request returns a 200 status code and an employee object.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmployeeSuccessResponse"
        "404":
          description: An unsuccessful request returns a 404 status code for employees that are not found.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmployeeErrorResponse"
    patch:
      tags:
        - Employees
      summary: Update an Employee record, for mutable properties
      operationId: massgov.pfml.api.employees.employees_patch
      parameters:
        - name: employee_id
          in: path
          schema:
            type: string
          description: ID of Employee to update
          required: true
      responses:
        "200":
          description: A successful response returns a 200 status code and an employee object.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmployeeResponse"
        "404":
          $ref: "#/components/responses/NotFound"
      requestBody:
        $ref: "#/components/requestBodies/EmployeeUpdateRequest"

  /employees/search:
    post:
      tags:
        - Employees
      summary: Lookup an Employee by SSN/ITIN and name
      operationId: massgov.pfml.api.employees.employees_search
      responses:
        "200":
          description: A successful response returns a 200 status code and an employee object.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmployeeResponse"
        "404":
          $ref: "#/components/responses/NotFound"
      requestBody:
        $ref: "#/components/requestBodies/EmployeeSearchRequest"

  /employers/{employer_id}:
    get:
      tags:
        - Employers
      summary: Retrieve an Employer record
      operationId: massgov.pfml.api.employers.employers_get
      parameters:
        - name: employer_id
          in: path
          schema:
            type: string
            format: uuid
          description: ID of Employer to retrieve
          required: true
      responses:
        "200":
          description: A successful request returns a 200 status code and an employer object.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmployerResponse"
        "404":
          $ref: "#/components/responses/NotFound"

  /applications:
    post:
      tags:
        - Applications
      summary: Create an Application
      operationId: massgov.pfml.api.applications.applications_start
      parameters:
        - name: user_id
          in: header
          schema:
            type: string
            format: uuid
          description: ID of User the Application belongs to
          required: true
      responses:
        "201":
          $ref: "#/components/responses/ApplicationCreatedResponse"
        "400":
          $ref: "#/components/responses/BadRequest"

    get:
      tags:
        - Applications
      summary: Retrieve all Applications for the specified user
      operationId: massgov.pfml.api.applications.applications_get
      parameters:
        - name: user_id
          in: header
          schema:
            type: string
            format: uuid
          description: ID of User the Application belongs to
          required: true
      responses:
        "200":
          $ref: "#/components/responses/ApplicationSearchResponse"

  /applications/{application_id}:
    get:
      tags:
        - Applications
      summary: Retrieve an Application identified by the application id
      operationId: massgov.pfml.api.applications.application_get
      parameters:
        - name: user_id
          in: header
          schema:
            type: string
            format: uuid
          description: ID of User the Application belongs to
          required: true
        - name: application_id
          in: path
          schema:
            type: string
            format: uuid
          description: ID of Application to retrieve
          required: true
      responses:
        "200":
          $ref: "#/components/responses/ApplicationResponse"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      tags:
        - Applications
      summary: Update an Application
      description: >
        Supports partial update of an Application record.

        It is expected clients will call this endpoint multiple times and with
        incomplete data as individual pieces of information is collected from
        the user. The API will review the data provided and return any pertinent
        warnings or errors.
      operationId: massgov.pfml.api.applications.applications_update
      parameters:
        - name: user_id
          in: header
          schema:
            type: string
            format: uuid
          description: ID of User the Application belongs to
          required: true
        - name: application_id
          in: path
          schema:
            type: string
            format: uuid
          description: ID of Application to update
          required: true
      responses:
        "200":
          description: Application updated without errors.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApplicationUpdateResponse"
        "400":
          $ref: "#/components/responses/ApplicationUpdateResponse"
      requestBody:
        $ref: "#/components/requestBodies/ApplicationRequestBody"

  /applications/{application_id}/submit_application:
    post:
      tags:
        - Applications
      summary: >
        Signal the data entry is complete and the application is ready to be
        submitted to the Claims Processing System.
      operationId: massgov.pfml.api.applications.applications_submit
      parameters:
        - name: user_id
          in: header
          schema:
            type: string
            format: uuid
          description: ID of User the Application belongs to
          required: true
        - name: application_id
          in: path
          schema:
            type: string
            format: uuid
          description: ID of Application to update
          required: true
      responses:
        "201":
          description: Application completed without errors.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApplicationUpdateResponse"
        "400":
          $ref: "#/components/responses/ApplicationUpdateResponse"

tags:
  - name: Test Endpoints
  - name: Users
  - name: Employees
  - name: Employers
  - name: Applications

components:
  securitySchemes:
    jwt:
      type: http
      scheme: bearer
      bearerFormat: JWT
      x-bearerInfoFunc: massgov.pfml.api.authentication.decode_cognito_token

  requestBodies:
    UserUpdateRequest:
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/UserUpdateRequest"
      required: true
    EmployeeSearchRequest:
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/EmployeeSearchRequest"
      required: true
    EmployeeUpdateRequest:
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/EmployeeUpdateRequest"
      required: true
    ApplicationRequestBody:
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApplicationRequestBody"
      required: true

  responses:
    ApplicationUpdateResponse:
      description: Application updated
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApplicationUpdateResponse"
    ApplicationResponse:
      description: Application found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApplicationResponse"
    ApplicationCreatedResponse:
      description: A new application successfully created
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApplicationCreated"
    ApplicationSearchResponse:
      description: Search successful
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApplicationSearchResults"
    NotFound:
      description: The specified resource was not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    BadRequest:
      description: There was a problem with your request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    ValidationError:
      description: Error validating the object
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

  schemas:
    UserResponse:
      type: object
      properties:
        user_id:
          type: string
          example: "009fa369-291b-403f-a85a-15e938c26f2f"
        auth_id:
          type: string
          format: uuid
          example: "00000000-291b-403f-a85a-15e938c26f2f"
        email_address:
          type: string
          format: email
          example: "janedoe@example.com"
        consented_to_data_sharing:
          type: boolean
          example: false

    UserUpdateRequest:
      type: object
      additionalProperties: false
      properties:
        consented_to_data_sharing:
          type: boolean
          example: true
      required: ['consented_to_data_sharing']

    EmployeeUpdateRequest:
      type: object
      properties:
        first_name:
          type: string
          example: "Jane"
          nullable: false
          minLength: 1
        middle_name:
          type: string
          example: "Alice"
          nullable: false
          minLength: 1
        last_name:
          type: string
          example: "Doe"
          nullable: false
          minLength: 1
        email_address:
          type: string
          format: email
          example: "j.a.doe@gmail.com"
          nullable: false
          minLength: 1

    EmployeeSearchRequest:
      type: object
      properties:
        first_name:
          type: string
          example: "Jane"
        middle_name:
          type: string
          example: "Alice"
        last_name:
          type: string
          example: "Doe"
        tax_identifier:
          $ref: '#/components/schemas/SsnItin'
      required: ['first_name', 'last_name', 'tax_identifier']

    EmployeeErrorResponse:
      type: object
      
    EmployeeSuccessResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/EmployeeDataResponse'

    EmployeeDataResponse:
      type: object
      properties:
        item:
          $ref: '#/components/schemas/EmployeeResponse'

    EmployeeResponse:
      type: object
      properties:
        employee_id:
          type: string
          format: uuid
          example: "009fa369-291b-403f-a85a-15e938c26a7b"
        first_name:
          type: string
          example: "Jane"
        middle_name:
          type: string
          nullable: true
          example: "Alice"
        other_name:
          type: string
          nullable: true
          example: "Marie"
        email_address:
          type: string
          format: email
          nullable: true
          example: "jdoe@gmail.com"
        last_name:
          type: string
          example: "Doe"
        phone_number:
          type: string
          nullable: true
          example: "123-456-7890"
        tax_identifier:
          $ref: '#/components/schemas/SsnItin'
      required: ['employee_id', 'tax_identifier']

    EmployerResponse:
      type: object
      properties:
        employer_id:
          type: string
          format: uuid
          example: "009fa369-291b-403f-a85a-15e938c26f2f"
        employer_fein:
          type: string
          example: "41-9904348"
        employer_dba:
          type: string
          example: "The Super Store"
      additionalProperties: false
      required:
        - employer_id
        - employer_fein
        - employer_dba

    ApplicationCreated:
      type: object
      properties:
        application_id:
          type: string
          format: uuid
          example: "2a340cf8-6d2a-4f82-a075-73588d003f8f"

    ApplicationRequestBody:
      type: object
      properties:
        application_nickname:
          type: string
          nullable: true
          example: "My bonding leave request"
        employee_ssn:
          nullable: true
          $ref: "#/components/schemas/SsnItin"
        employer_fein:
          nullable: true
          $ref: "#/components/schemas/Fein"
        first_name:
          type: string
          nullable: true
          example: "John"
        last_name:
          type: string
          nullable: true
          example: "Doe"
        occupation:
          type: string
          nullable: true
          enum:
            - Sales Clerk
            - Administrative
            - Engineer
            - Health Care
          example:  "Sales Clerk"
        leave_details:
          $ref: "#/components/schemas/ApplicationLeaveDetails"
        payment_preferences:
          type: array
          items:
            $ref: "#/components/schemas/PaymentPreferences"

    ApplicationResponse:
      type: object
      properties:
        application_nickname:
          type: string
          example: "My bonding leave request"
          nullable: true
        application_id:
          type: string
          format: uuid
          example: "2a340cf8-6d2a-4f82-a075-73588d003f8f"
        employee_id:
          type: string
          format: uuid
          example: "8623c9f2-8275-417b-b5d7-4bb32fedb7a7"
          nullable: true
        employer_id:
          type: string
          format: uuid
          example: "2f0f58a0-fcad-465b-b474-ee6c961cd6e3"
          nullable: true
        first_name:
          type: string
          example: "John"
          nullable: true
        last_name:
          type: string
          example: "Doe"
          nullable: true
        occupation:
          type: string
          enum:
            - Sales Clerk
            - Administrative
            - Engineer
            - Doctor
          example: "Sales Clerk"
          nullable: true
        leave_details:
          $ref: "#/components/schemas/ApplicationLeaveDetails"
          nullable: true
        payment_preferences:
          type: array
          items:
            $ref: "#/components/schemas/PaymentPreferences"
          nullable: true
        updated_time:
          type: string
          format: date-time
          example: "2020-06-26T01:02:03.967736Z"
        status:
          type: string
          description: |
            The current application status.

            * `Started` - is started and in progress.
            * `Completed` - is marked complete and has been submitted by the user.
            * `Submitted` - is successfully stored in the claims processing system.
          enum:
            - Started
            - Completed
            - Submitted
          example: "Started"

    ApplicationLeaveDetails:
      type: object
      properties:
        reason:
          type: string
          nullable: true
          enum:
            - Care For A Family Member
            - Pregnancy/Maternity
            - Child Bonding
            - Serious Health Condition - Employee
          example: "Care For A Family Member"
        reason_qualifier:
          type: string
          nullable: true
          enum:
            - New Born
            - Serious Health Condition
            - Work Related Accident/Injury
          example: "Serious Health Condition"
        reduced_schedule_leave_periods:
          type: array
          items:
            $ref: "#/components/schemas/ReducedScheduleLeavePeriods"
        continuous_leave_periods:
          type: array
          items:
            $ref: "#/components/schemas/ContinuousLeavePeriods"
        intermittent_leave_periods:
          type: array
          items:
            $ref: "#/components/schemas/IntermittentLeavePeriods"
        relationship_to_caregiver:
          type: string
          nullable: true
          enum:
            - Parent
            - Child
            - Grandparent
            - Grandchild
            - Other Family Member
            - Service Member
            - Inlaw
            - Sibling
            - Other
          example: "Parent"
        relationship_qualifier:
          type: string
          nullable: true
          enum:
            - Adoptive
            - Biological
            - Foster
            - Custodial Parent
            - Legal Guardian
            - Step Parent
          example: "Biological"
        employer_notified:
          type: boolean
          nullable: true
          example: true
        employer_notification_date:
          type: string
          nullable: true
          format: date
          example: "2020-04-24"
        employer_notification_method:
          type: string
          nullable: true
          enum:
            - In Writing
            - In Person
            - By Telephone
            - Other
          example: "In Writing"

    ReducedScheduleLeavePeriods:
      type: object
      properties:
        leave_period_id:
          type: string
          format: uuid
          nullable: true
        start_date:
          type: string
          nullable: true
          format: date
          example: "2020-06-08"
        end_date:
          type: string
          nullable: true
          format: date
          example: "2020-07-31"
        is_estimated:
          type: boolean
          nullable: true
          default: true
          example: true
        thursday_off_hours:
          type: integer
          nullable: true
          example: 4
        thursday_off_minutes:
          type: integer
          nullable: true
          example: 0
        friday_off_hours:
          type: integer
          nullable: true
          example: 4
        friday_off_minutes:
          type: integer
          nullable: true
          example: 30
        saturday_off_hours:
          type: integer
          nullable: true
          example: 0
        saturday_off_minutes:
          type: integer
          nullable: true
          example: 0
        sunday_off_hours:
          type: integer
          nullable: true
          example: 0
        sunday_off_minutes:
          type: integer
          nullable: true
          example: 0
        monday_off_hours:
          type: integer
          nullable: true
          example: 4
        monday_off_minutes:
          type: integer
          nullable: true
          example: 0
        tuesday_off_hours:
          type: integer
          nullable: true
          example: 4
        tuesday_off_minutes:
          type: integer
          nullable: true
          example: 0
        wednesday_off_hours:
          type: integer
          nullable: true
          example: 4
        wednesday_off_minutes:
          type: integer
          nullable: true
          example: 0

    ContinuousLeavePeriods:
      type: object
      properties:
        leave_period_id:
          type: string
          format: uuid
          nullable: true
        start_date:
          type: string
          nullable: true
          format: date
          example: "2020-06-08"
        end_date:
          type: string
          nullable: true
          format: date
          example: "2020-07-31"
        last_day_worked:
          type: string
          nullable: true
          format: date
          example: "2020-06-05"
        expected_return_to_work_date:
          type: string
          nullable: true
          format: date
          example: "2020-08-03"
        start_date_full_day:
          type: boolean
          nullable: true
          example: true
        start_date_off_hours:
          type: integer
          nullable: true
          example: 0
        start_date_off_minutes:
          type: integer
          nullable: true
          example: 0
        end_date_off_hours:
          type: integer
          nullable: true
          example: 0
        end_date_off_minutes:
          type: integer
          nullable: true
          example: 0
        end_date_full_day:
          type: boolean
          nullable: true
          example: true
        is_estimated:
          type: boolean
          nullable: true
          default: true
          example: true

    IntermittentLeavePeriods:
      type: object
      properties:
        leave_period_id:
          type: string
          format: uuid
          nullable: true
        start_date:
          type: string
          nullable: true
          format: date
          example: "2020-06-08"
        end_date:
          type: string
          nullable: true
          format: date
          example: "2020-07-31"
        frequency:
          type: integer
          nullable: true
          example: 4
        frequency_interval:
          type: integer
          nullable: true
          example: 2
        frequency_interval_basis:
          type: string
          nullable: true
          enum:
            - Days
            - Weeks
            - Months
          example: "Weeks"
        duration:
          type: integer
          nullable: true
          example: 2
        duration_basis:
          type: string
          nullable: true
          enum:
            - Minutes
            - Hours
            - Days
          example: "Days"

    PaymentPreferences:
      type: object
      properties:
        payment_preference_id:
          type: string
          format: uuid
          nullable: true
        description:
          type: string
          nullable: true
        payment_method:
          type: string
          nullable: true
          enum:
            - ACH
            - Check
            - Gift Card
          example: "ACH"
        is_default:
          type: boolean
          nullable: true
        account_details:
          $ref: "#/components/schemas/ApplicationPaymentAccountDetails"
        cheque_details:
          $ref: "#/components/schemas/ApplicationPaymentChequeDetails"

    ApplicationPaymentAccountDetails:
      type: object
      properties:
        account_number:
          type: string
          nullable: true
          minLength: 6
          maxLength: 17
          example: "1234567"
        routing_number:
          nullable: true
          $ref: "#/components/schemas/RoutingNbr"
        account_name:
          type: string
          nullable: true
          example: "My Checking"
        account_type:
          type: string
          nullable: true
          enum:
            - Checking
            - Savings
          example: "Checking"

    ApplicationPaymentChequeDetails:
      type: object
      properties:
        name_to_print_on_check:
          type: string
          nullable: true
          example: "John Doe"

    ApplicationUpdateResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        warnings:
          type: array
          items:
            $ref: "#/components/schemas/WarningsAndErrors"
        errors:
          type: array
          items:
            $ref: "#/components/schemas/WarningsAndErrors"
      required:
        - code
        - message

    WarningsAndErrors:
      type: object
      properties:
        message:
          type: string
        attribute:
          type: string

    ApplicationSearchResults:
      type: array
      items:
        $ref: "#/components/schemas/ApplicationResponse"

    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
      required:
        - code
        - message

    SsnItin:
      type: string
      example: "000-00-0000"
      pattern: '^\d{3}-\d{2}-\d{4}$'

    Fein:
      type: string
      example: "00-0000000"
      pattern: '^\d{2}-\d{7}$'

    RoutingNbr:
      type: string
      example: "000000000"
      pattern: "^((0[0-9])|(1[0-2])|(2[1-9])|(3[0-2])|(6[1-9])|(7[0-2])|80)([0-9]{7})$"

    Uuid:
      type: string
      example: "009fa369-291b-403f-a85a-15e938c26f2f"
      format: uuid
