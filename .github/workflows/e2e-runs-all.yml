name: E2E Test Suite (All Environments)
#
# This workflow is to trigger scheduled runs every morning
#
# Scheduled runs will trigger a workflow_dispatch for all
# enviornments via the End-to-End Test Suite workflow

on:
  workflow_dispatch:
    inputs:
      cypress_tags:
        description: "Cypress Run Tags"
        required: false
        default: "Manual"
  schedule:
    - cron:  '0 11 * * 1-5'

jobs:
  trigger_e2e:
    name: Run Cypress Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment: [ "test", "stage", "performance", "training", "uat", "cps-preview" ]
    steps:
      - uses: actions/checkout@v2
      - name: Set output
        id: vars
        run: echo ::set-output name=short_ref::${GITHUB_REF#refs/*/}

      - name: "Trigger Manual Cypress Run in ${{ matrix.environment }}"
        if: github.event_name == 'workflow_dispatch'
        uses: ./.github/actions/trigger-cypress
        with:
          target_environment: "${{ matrix.environment }}"
          cypress_tags: ${{ github.event.inputs.cypress_tags }}
          github_token: ${{ secrets.PFML_DEVOPS_TOKEN }}
          github_branch: ${{ steps.vars.outputs.short_ref }}
          wait_for_results: "false"
          only_stable: 'false'

      - name: "Trigger Scheduled Cypress Run in ${{ matrix.environment }}"
        if: github.event_name == 'schedule'
        uses: ./.github/actions/trigger-cypress
        with:
          target_environment: "${{ matrix.environment }}"
          cypress_tags: ${{ format('Morning Run ({0})', matrix.environment) }}
          github_token: ${{ secrets.PFML_DEVOPS_TOKEN }}
          github_branch: 'main'
          wait_for_results: "false"
          only_stable: 'true'