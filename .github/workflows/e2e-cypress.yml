name: End-to-End Test Suite
#
# This workflow runs Cypress tests in a parallel fashion.
#
# Tests are split into three categories:
#
# * Stable - tests that must pass before release.
# * Unstable - tests that are advisory (for upcoming features) and should not block release.
# * Ignored - tests that are not run at all in CI.

on:
  # Manual runs.
  workflow_dispatch:
    inputs:
      target_environment:
        description: "Target Environment"
        required: true
        default: "stage"
      cypress_tags:
        description: "Cypress Run Tags"
        required: false
        default: "Manual"
  # E2E PRs that touch Cypress.
  pull_request:
    paths:
      - e2e/cypress/**
      - e2e/cypress.json
      - e2e/package.json
      - e2e/employee.json
  # Nightly runs (Midnight UTC)
  schedule:
    - cron: '0 0 * * *'

jobs:
  cypress:
    name: Run Cypress Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        containers: [1,2,3]
    steps:
      - uses: actions/checkout@v2

      # Set Cypress Tags according to what type of event we're dealing with.
      - name: Set variables for PR
        if: github.event_name == 'pull_request'
        run: |
          echo "cypress_tags=PR" >> $GITHUB_ENV
          echo "E2E_ENVIRONMENT=test" >> $GITHUB_ENV
          echo "COMMIT_INFO_MESSAGE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
      - name: Set variables for Nightly
        if: github.event_name == 'schedule'
        run: |
          echo "cypress_tags=Nightly" >> $GITHUB_ENV
          echo "E2E_ENVIRONMENT=test" >> $GITHUB_ENV
      - name: Set variables for manual run
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "cypress_tags=${{ github.event.inputs.cypress_tags }}" >> $GITHUB_ENV
          echo "E2E_ENVIRONMENT=${{ github.event.inputs.target_environment }}" >> $GITHUB_ENV

      # Run Cypress tests.
      - name: Cypress Tests (1.0 Launch)
        uses: cypress-io/github-action@v2
        with:
          spec: "cypress/specs/stable/**"
          record: true
          parallel: true
          working-directory: e2e
          group: 1.0 Launch
          tag: "${{ env.cypress_tags }},Env-${{ env.E2E_ENVIRONMENT }}"
        env:
          # Setup any secret overrides that are necessary here.
          # Most other environment variables will come from /e2e/config.json,
          # as determined by the E2E_ENVIRONMENT variable set above.
          E2E_FINEOS_PASSWORD: ${{ secrets.E2E_FINEOS_PASSWORD }}
          E2E_PORTAL_PASSWORD: ${{ secrets.E2E_PORTAL_PASSWORD }}
          E2E_TESTMAIL_APIKEY: ${{ secrets.E2E_TESTMAIL_APIKEY }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}

      # Run Cypress tests.
      - name: Cypress Tests (1.1 Launch)
        uses: cypress-io/github-action@v2
        with:
          spec: "cypress/specs/unstable/**"
          record: true
          parallel: true
          working-directory: e2e
          group: 1.1 Launch
          install: false # Skip install on second run.
          tag: "${{ env.cypress_tags }},Env-${{ env.E2E_ENVIRONMENT }}"
        env:
          # Setup any secret overrides that are necessary here.
          # Most other environment variables will come from /e2e/config.json,
          # as determined by the E2E_ENVIRONMENT variable set above.
          E2E_FINEOS_PASSWORD: ${{ secrets.E2E_FINEOS_PASSWORD }}
          E2E_PORTAL_PASSWORD: ${{ secrets.E2E_PORTAL_PASSWORD }}
          E2E_TESTMAIL_APIKEY: ${{ secrets.E2E_TESTMAIL_APIKEY }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
        # Always run this step, even if 1.0 fails.
        if: always()
        # Do not allow this step to fail the job. It is informational, not mandatory.
        # This should be removed when we are ready to make 1.1 tests mandatory.
        continue-on-error: true
