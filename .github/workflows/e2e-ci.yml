# End to End testing CI processes.
#
name: End-to-End CI Testing

on:
  pull_request:
    paths:
      - e2e/**
      - .github/workflows/e2e-ci.yml
defaults:
  run:
    working-directory: e2e

env:
  CYPRESS_CACHE_FOLDER: /home/runner/.npm/.cypress-cache
  PLAYWRIGHT_BROWSERS_PATH: /home/runner/.npm/.playwright-cache
  PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 1 # We never actually need puppeteer chromium installed.

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v2
        with: { node-version: "14.x" }
      - name: "Install Node Modules"
        uses: bahmutov/npm-install@v1
        with:
          working-directory: e2e
      - name: "Lint"
        run: npm run lint:ci

  test:
    name: "Unit Tests"
    runs-on: ubuntu-latest
    env:
      E2E_ENVIRONMENT: test
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v2
        with: { node-version: "14.x" }
      - name: "Install Node Modules"
        uses: bahmutov/npm-install@v1
        with:
          working-directory: e2e
      - name: "Run Jest"
        run: npm run test:unit

  changed-files:
    name: "Check Changed Files"
    runs-on: ubuntu-latest
    outputs:
      has-flood-changes: ${{ steps.flood-changed-files.outputs.any_changed }}
      has-artillery-changes: ${{ steps.artillery-changed-files.outputs.any_changed }}
      has-cypress-changes: ${{ steps.cypress-changed-files.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v2
      - name: "Check if Flood files have been changed"
        id: flood-changed-files
        uses: tj-actions/changed-files@v8.1
        with:
          files: "e2e/src/flood/**"
      - name: "Check if Artillery files have been changed"
        id: artillery-changed-files
        uses: tj-actions/changed-files@v8.1
        with:
          files: "e2e/src/artillery/**"
      - name: "Check if Cypress files have been changed"
        id: cypress-changed-files
        uses: tj-actions/changed-files@v8.1
        with:
          files: |
            e2e/cypress/**
            e2e/package.json

  check-flood:
    name: "Check Flood Bundling"
    runs-on: ubuntu-latest
    env:
      E2E_FLOOD_API_TOKEN: ${{ secrets.E2E_FLOOD_API_TOKEN }}
      E2E_FINEOS_PASSWORD: ${{ secrets.E2E_FINEOS_PASSWORD }}
      E2E_PORTAL_PASSWORD: ${{ secrets.E2E_PORTAL_PASSWORD }}
      E2E_TESTMAIL_APIKEY: ${{ secrets.E2E_TESTMAIL_APIKEY }}
      E2E_FINEOS_USERS: ${{ secrets.E2E_FINEOS_USERS }}
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v2
        with: { node-version: "14.x" }
      - name: "Install Node Modules"
        uses: bahmutov/npm-install@v1
        with:
          working-directory: e2e
      - name: "Build Flood Bundle"
        run: E2E_ENVIRONMENT=performance npm run cli -- flood base --bundle
      - name: "Attempt Flood Compilation"
        run: node_modules/.bin/element compile data/flood/latest/index.ts
      - name: "Check compiled script is runnable"
        run: node index_compiled.js

  check-lst-scenarios:
    name: "Run scenarios if any flood code has changed"
    runs-on: ubuntu-latest
    needs: changed-files
    env:
      E2E_FLOOD_API_TOKEN: ${{ secrets.E2E_FLOOD_API_TOKEN }}
      E2E_FINEOS_PASSWORD: ${{ secrets.E2E_FINEOS_PASSWORD }}
      E2E_PORTAL_PASSWORD: ${{ secrets.E2E_PORTAL_PASSWORD }}
      E2E_TESTMAIL_APIKEY: ${{ secrets.E2E_TESTMAIL_APIKEY }}
      E2E_FINEOS_USERS: ${{ secrets.E2E_FINEOS_USERS }}
    if: needs.changed-files.outputs.has-flood-changes == 'true'
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v2
        with: { node-version: "14.x" }
      - name: "Install Node Modules"
        uses: bahmutov/npm-install@v1
        with:
          working-directory: e2e
      - name: "Generate Base data"
        run: E2E_ENVIRONMENT=performance npm run cli -- flood base
      - name: "Generate Leave Admin data"
        run: E2E_ENVIRONMENT=performance npm run cli -- flood leaveAdmin
      - name: "Run PortalClaimSubmit scenario"
        run: node_modules/.bin/element run src/flood/scenarios/PortalClaimSubmit.perf.ts
      - name: "Run LeaveAdminSelfReg scenario"
        run: node_modules/.bin/element run src/flood/scenarios/LeaveAdminSelfReg.perf.ts
      - name: "Run SavilinxAgent scenario"
        run: node_modules/.bin/element run src/flood/scenarios/SavilinxAgent.perf.ts

  check-artillery:
    name: "Run docker and build image for artillery deploy"
    runs-on: ubuntu-latest
    needs: changed-files
    env:
      E2E_ENVIRONMENT: performance
      E2E_FINEOS_PASSWORD: ${{ secrets.E2E_FINEOS_PASSWORD }}
      E2E_PORTAL_PASSWORD: ${{ secrets.E2E_PORTAL_PASSWORD }}
      E2E_EMPLOYER_PORTAL_PASSWORD: ${{ secrets.E2E_EMPLOYER_PORTAL_PASSWORD }}
      E2E_TESTMAIL_APIKEY: ${{ secrets.E2E_TESTMAIL_APIKEY }}
      E2E_FINEOS_USERS: ${{ secrets.E2E_FINEOS_USERS }}
    if: needs.changed-files.outputs.has-artillery-changes == 'true'
    steps:
      - uses: actions/checkout@v2
      - name: "Build the Docker Image ..."
        run: docker build --pull --rm -f e2e/Dockerfile

  trigger-cypress:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.has-cypress-changes == 'true'
    steps:
      - name: Trigger E2E Workflow
        uses: aurelien-baudet/workflow-dispatch@v2
        with:
          workflow: e2e-cypress.yml
          token: ${{ secrets.PFML_DEVOPS_TOKEN }}
          wait-for-completion: true
          ref: ${{ github.event.pull_request.head.ref }}
          inputs: |
            {
              "target_environment": "test",
              "cypress_tags": "PR",
              "run_unstable": "true",
              "title_override": ${{ toJSON(format('PR: {0}', github.event.pull_request.title)) }}
            }
