# Scripted Releases Github Actions Workflow 

name: Scripted Releases

on:
  workflow_dispatch:
    inputs:
      application:
        description: |
          ‚ö†Ô∏è Only edit the above dropdown if you do not wish to use the GHA Workflow from main
          --------------------------------------------
          1Ô∏è‚É£ Application
        required: true
        type: choice
        options:
          - api
          - portal
          - foobar
      scripted-release-task:
        description: |
          2Ô∏è‚É£ Scripted Release Task
        required: true
        type: choice
        options:
          - start-release
          - update-release
          - finalize-release
          - hotfix
          - major-release
      arguments:
        description: |
          3Ô∏è‚É£ Arguments - 
          ü§î check bin/ci/README.md for help
        required: false
        type: string

jobs:
  run-scripted-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PMFL repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Poetry
        working-directory: ./bin/ci
        # Installing with curl requires an extra step to add poetry to $PATH 
        run: pip install poetry

      - name: Install Poetry dependencies 
        working-directory: ./bin/ci
        run: poetry install
      
      - name: Run scripted releases with Poetry 
        working-directory: ./bin/ci
        run: poetry run scripted-releases -a ${{ github.event.inputs.application }} ${{ github.event.inputs.scripted-release-task }} ${{ github.event.inputs.arguments }}

  create-release-with-release-notes:
    runs-on: ubuntu-latest
    needs: run-scripted-releases
    # Previous job must finish successfully and do not allow foobar application to create release
    if: needs.run-scripted-releases.outcome == 'success' && contains(github.event.inputs.application, 'api') || contains(github.event.inputs.application, 'portal')

    steps:
      - name: Checkout PFML repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Fetch all tags and create variable capturing the tag created in previous job
      - name: Fetch tags
        id: version
        working-directory: ./${{ github.event.inputs.application }}
        run: |
          tag=$(git tag -l "${{ github.event.inputs.application }}*" --sort=committerdate | tail -1)
          echo "::set-output name=tag::$tag"

      # Create release and notes in GitHub
      - name: publish to GitHub
        working-directory: ./${{ github.event.inputs.application }}
        env:
        # Use DevOps token so job will have enough permissions to create final release
          GITHUB_TOKEN: ${{ secrets.PFML_DEVOPS_TOKEN }}
        # If there's "-rc" in the tag, then label the release as a pre-release 
        run: |
          if [[ "${{ steps.version.outputs.tag }}" == *"-rc"* ]]
          then
            gh release create ${{ steps.version.outputs.tag }} --notes "$(make release-notes)" --title "${{ steps.version.outputs.tag }}" --prerelease
          else
            gh release create ${{ steps.version.outputs.tag }} --notes "$(make release-notes)" --title "${{ steps.version.outputs.tag }}"
