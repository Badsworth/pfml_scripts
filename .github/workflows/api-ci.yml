# Run tests and linting for the Paid Leave API.
#
name: API CI Testing

on:
  pull_request:
    paths:
    - api/**

env:
  working-dir: ./api
  CI: true

jobs:

  # Check for formatting and linting issues.
  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    # for efficiency, spin up the container once and run commands in the same
    # environment, instead of starting and stopping the container for each step
    - name: build and start container
      run: make start
      working-directory: ${{ env.working-dir }}

    - name: format-check
      run: make format-check
      working-directory: ${{ env.working-dir }}

    - name: lint
      run: make lint
      working-directory: ${{ env.working-dir }}

  # Check for test failures.
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: build and start container
      run: make start
      working-directory: ${{ env.working-dir }}

    - name: test
      run: make test
      working-directory: ${{ env.working-dir }}

  # Check we can build a release
  build-release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: build
      run: make release-build
      working-directory: ${{ env.working-dir }}
